{% extends "base.html" %}

{% block title %}Analysis Results - VRAQ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    PCB Analysis Results
                </h3>
                <div>
                    <span class="badge {% if results.overall_status == 'OK' %}bg-success{% elif results.overall_status == 'DEFECTS_FOUND' %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                        {{ results.overall_status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-id-card me-2"></i>Analysis ID</h6>
                        <p class="font-monospace">{{ results.analysis_id }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock me-2"></i>Timestamp</h6>
                        <p>{{ results.timestamp }}</p>
                    </div>
                </div>
                
                {% if results.error %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Error:</strong> {{ results.error }}
                    </div>
                {% else %}
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-dark border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                    <h5 class="text-success">{{ results.components | selectattr('status', 'equalto', 'OK') | list | length }}</h5>
                                    <p class="mb-0">Components OK</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-crosshairs fa-2x text-warning mb-2"></i>
                                    <h5 class="text-warning">{{ results.components | selectattr('status', 'equalto', 'MISALIGNED') | list | length }}</h5>
                                    <p class="mb-0">Misaligned</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark border-danger">
                                <div class="card-body text-center">
                                    <i class="fas fa-search-minus fa-2x text-danger mb-2"></i>
                                    <h5 class="text-danger">{{ results.components | selectattr('status', 'equalto', 'MISSING') | list | length }}</h5>
                                    <p class="mb-0">Missing</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Side-by-Side Image Comparison -->
                {% if results.reference_image_url and results.test_image_url %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h5><i class="fas fa-images me-2"></i>Image Comparison</h5>
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="image-comparison-container">
                                            <h6 class="text-success"><i class="fas fa-check-circle me-1"></i>Reference PCB (Perfect)</h6>
                                            <div class="position-relative">
                                                <img src="{{ results.reference_image_url }}" class="img-fluid rounded border" alt="Reference PCB" id="reference-image">
                                                <canvas id="reference-overlay" class="position-absolute top-0 start-0"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="image-comparison-container">
                                            <h6 class="text-warning"><i class="fas fa-search me-1"></i>Test PCB (Under Analysis)</h6>
                                            <div class="position-relative">
                                                <img src="{{ results.test_image_url }}" class="img-fluid rounded border test-image-bw" alt="Test PCB" id="test-image">
                                                <canvas id="test-overlay" class="position-absolute top-0 start-0"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="toggleDefectMarkers()" id="marker-toggle">
                                            <i class="fas fa-eye me-1"></i>Show Defect Markers
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetImageView()">
                                            <i class="fas fa-refresh me-1"></i>Reset View
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-list me-2"></i>Component Details</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportResults()">
                            <i class="fas fa-download me-1"></i>
                            Export JSON
                        </button>
                    </div>
                </div>
                
                {% if results.components %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-microchip me-1"></i>Component</th>
                                    <th><i class="fas fa-tags me-1"></i>Type</th>
                                    <th><i class="fas fa-flag me-1"></i>Status</th>
                                    <th><i class="fas fa-percentage me-1"></i>Confidence</th>
                                    <th><i class="fas fa-map-marker-alt me-1"></i>Expected Location</th>
                                    <th><i class="fas fa-crosshairs me-1"></i>Detected Location</th>
                                    <th><i class="fas fa-ruler me-1"></i>Deviation (px)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in results.components %}
                                    <tr class="{% if component.status == 'MISSING' %}table-danger{% elif component.status == 'MISALIGNED' %}table-warning{% else %}table-success{% endif %}">
                                        <td>
                                            <span class="fw-bold">{{ component.name }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ component.component_type }}</span>
                                        </td>
                                        <td>
                                            <span class="badge {% if component.status == 'OK' %}bg-success{% elif component.status == 'MISALIGNED' %}bg-warning{% else %}bg-danger{% endif %}">
                                                {% if component.status == 'OK' %}
                                                    <i class="fas fa-check me-1"></i>
                                                {% elif component.status == 'MISALIGNED' %}
                                                    <i class="fas fa-crosshairs me-1"></i>
                                                {% else %}
                                                    <i class="fas fa-times me-1"></i>
                                                {% endif %}
                                                {{ component.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                    <div class="progress-bar {% if component.confidence >= 0.8 %}bg-success{% elif component.confidence >= 0.5 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         style="width: {{ (component.confidence * 100) | round(1) }}%"></div>
                                                </div>
                                                <small class="text-muted">{{ (component.confidence * 100) | round(1) }}%</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="font-monospace">
                                                [{{ component.expected_location[0] }}, {{ component.expected_location[1] }}]
                                            </span>
                                        </td>
                                        <td>
                                            {% if component.detected_location %}
                                                <span class="font-monospace">
                                                    [{{ component.detected_location[0] }}, {{ component.detected_location[1] }}]
                                                </span>
                                            {% else %}
                                                <span class="text-muted">Not detected</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if component.deviation_pixels is not none %}
                                                <span class="{% if component.deviation_pixels <= 5 %}text-success{% elif component.deviation_pixels <= 15 %}text-warning{% else %}text-danger{% endif %}">
                                                    {{ component.deviation_pixels | round(1) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No components detected</h5>
                        <p class="text-muted">Try adjusting the confidence threshold or check image quality</p>
                    </div>
                {% endif %}
                
                {% if results.vr_data and results.vr_data.defect_markers %}
                    <div class="mt-4">
                        <h5><i class="fas fa-cube me-2"></i>VR Data</h5>
                        <div class="card bg-dark border-info">
                            <div class="card-body">
                                <h6 class="text-info">Defect Markers for VR Visualization</h6>
                                <div class="row">
                                    {% for marker in results.vr_data.defect_markers %}
                                        <div class="col-md-6 mb-2">
                                            <div class="border border-secondary rounded p-2">
                                                <strong>{{ marker.component }}</strong>
                                                <br>
                                                <small class="text-muted">
                                                    Type: {{ marker.type }}<br>
                                                    Position: X={{ marker.position.x | round(3) }}, Y={{ marker.position.y | round(3) }}, Z={{ marker.position.z | round(3) }}
                                                </small>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Analyze Another PCB
                    </a>
                    <a href="{{ url_for('template_management') }}" class="btn btn-secondary">
                        <i class="fas fa-images me-2"></i>
                        Manage Templates
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="results-data">
{{ results | tojson }}
</script>
{% endblock %}

{% block styles %}
<style>
.test-image-bw {
    filter: grayscale(100%) contrast(110%) brightness(95%);
    background: #f1f1f1;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let markersVisible = false;
const resultsData = JSON.parse(document.getElementById('results-data').textContent);

function exportResults() {
    const dataStr = JSON.stringify(resultsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `pcb_analysis_${resultsData.analysis_id}.json`;
    link.click();
}

function toggleDefectMarkers() {
    markersVisible = !markersVisible;
    const button = document.getElementById('marker-toggle');
    
    if (markersVisible) {
        button.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Defect Markers';
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');
        drawDefectMarkers();
    } else {
        button.innerHTML = '<i class="fas fa-eye me-1"></i>Show Defect Markers';
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
        clearDefectMarkers();
    }
}

function drawDefectMarkers() {
    const referenceCanvas = document.getElementById('reference-overlay');
    const testCanvas = document.getElementById('test-overlay');
    const referenceImg = document.getElementById('reference-image');
    const testImg = document.getElementById('test-image');
    
    if (!referenceCanvas || !testCanvas || !referenceImg || !testImg) return;
    
    // Set canvas dimensions to match images
    [referenceCanvas, testCanvas].forEach((canvas, index) => {
        const img = index === 0 ? referenceImg : testImg;
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
        canvas.style.width = img.clientWidth + 'px';
        canvas.style.height = img.clientHeight + 'px';
    });
    
    const refCtx = referenceCanvas.getContext('2d');
    const testCtx = testCanvas.getContext('2d');
    
    // Scale factors to adjust coordinates to displayed image size
    const refScaleX = referenceImg.clientWidth / referenceImg.naturalWidth;
    const refScaleY = referenceImg.clientHeight / referenceImg.naturalHeight;
    const testScaleX = testImg.clientWidth / testImg.naturalWidth;
    const testScaleY = testImg.clientHeight / testImg.naturalHeight;
    
    resultsData.components.forEach(component => {
        // Draw expected location on reference image (green circle)
        if (component.expected_location) {
            const refX = component.expected_location[0] * refScaleX;
            const refY = component.expected_location[1] * refScaleY;
            
            refCtx.strokeStyle = '#28a745';
            refCtx.fillStyle = 'rgba(40, 167, 69, 1)';
            refCtx.lineWidth = 3;
            refCtx.beginPath();
            refCtx.arc(refX, refY, 20, 0, 2 * Math.PI);
            refCtx.fill();
            refCtx.stroke();
            
            // Add component label
            refCtx.fillStyle = '#28a745';
            refCtx.font = 'bold 12px Arial';
            refCtx.fillText(component.name, refX + 25, refY - 10);
        }
        
        // Draw markers on test image based on status
        if (component.status === 'MISSING') {
            // Dark red X marker for missing components with background
            const refX = component.expected_location[0] * testScaleX;
            const refY = component.expected_location[1] * testScaleY;
            
            // Draw white background circle for better contrast
            testCtx.fillStyle = 'red';
            testCtx.beginPath();
            testCtx.arc(refX, refY, 25, 0, 2 * Math.PI);
            testCtx.fill();
            
            // // Draw thick dark red X
            // testCtx.strokeStyle = '#cc0000';
            // testCtx.lineWidth = 6;
            // testCtx.lineCap = 'round';
            // testCtx.beginPath();
            // testCtx.moveTo(refX - 18, refY - 18);
            // testCtx.lineTo(refX + 18, refY + 18);
            // testCtx.moveTo(refX + 18, refY - 18);
            // testCtx.lineTo(refX - 18, refY + 18);
            // testCtx.stroke();
            
            // Add dark background for label
            testCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            testCtx.fillRect(refX + 25, refY - 20, 140, 20);
            
            // Add white text label
            testCtx.fillStyle = 'white';
            testCtx.font = 'bold 14px Arial';
            testCtx.fillText('MISSING: ' + component.name, refX + 30, refY - 5);
            
        } else if (component.status === 'MISALIGNED' && component.detected_location) {
            // Dark orange arrow showing misalignment with better contrast
            const expectedX = component.expected_location[0] * testScaleX;
            const expectedY = component.expected_location[1] * testScaleY;
            const detectedX = component.detected_location[0] * testScaleX;
            const detectedY = component.detected_location[1] * testScaleY;
            
            // Draw white background circles for better visibility
            testCtx.fillStyle = 'white';
            testCtx.beginPath();
            testCtx.arc(expectedX, expectedY, 20, 0, 2 * Math.PI);
            testCtx.fill();
            testCtx.beginPath();
            testCtx.arc(detectedX, detectedY, 20, 0, 2 * Math.PI);
            testCtx.fill();
            
            // Draw thick dark orange arrow from expected to detected
            testCtx.strokeStyle = '#e67e00';
            testCtx.lineWidth = 5;
            testCtx.lineCap = 'round';
            testCtx.beginPath();
            testCtx.moveTo(expectedX, expectedY);
            testCtx.lineTo(detectedX, detectedY);
            testCtx.stroke();
            
            // Arrow head (bigger and more visible)
            const angle = Math.atan2(detectedY - expectedY, detectedX - expectedX);
            testCtx.beginPath();
            testCtx.moveTo(detectedX, detectedY);
            testCtx.lineTo(detectedX - 15 * Math.cos(angle - Math.PI/6), detectedY - 15 * Math.sin(angle - Math.PI/6));
            testCtx.moveTo(detectedX, detectedY);
            testCtx.lineTo(detectedX - 15 * Math.cos(angle + Math.PI/6), detectedY - 15 * Math.sin(angle + Math.PI/6));
            testCtx.stroke();
            
            // Dark circles at expected and detected positions
            testCtx.strokeStyle = '#e67e00';
            testCtx.fillStyle = 'rgba(230, 126, 0, 0.3)';
            testCtx.lineWidth = 4;
            testCtx.beginPath();
            testCtx.arc(expectedX, expectedY, 18, 0, 2 * Math.PI);
            testCtx.fill();
            testCtx.stroke();
            
            testCtx.beginPath();
            testCtx.arc(detectedX, detectedY, 18, 0, 2 * Math.PI);
            testCtx.fill();
            testCtx.stroke();
            
            // Add dark background for label
            const labelX = Math.max(expectedX, detectedX) + 25;
            const labelY = Math.min(expectedY, detectedY) - 20;
            testCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            testCtx.fillRect(labelX, labelY, 160, 20);
            
            // Add white text label
            testCtx.fillStyle = 'white';
            testCtx.font = 'bold 14px Arial';
            testCtx.fillText('MISALIGNED: ' + component.name, labelX + 5, labelY + 15);
            
        } else if (component.status === 'OK' && component.detected_location) {
            // Dark green checkmark for OK components with better visibility
            const detectedX = component.detected_location[0] * testScaleX;
            const detectedY = component.detected_location[1] * testScaleY;
            
            // Draw white background circle
            testCtx.fillStyle = 'gray';
            testCtx.beginPath();
            testCtx.arc(detectedX, detectedY, 20, 0, 2 * Math.PI);
            testCtx.fill();
            
            // Draw dark green circle
            testCtx.strokeStyle = '#006600';
            testCtx.fillStyle = 'rgba(0, 102, 0, 0.3)';
            testCtx.lineWidth = 4;
            testCtx.beginPath();
            testCtx.arc(detectedX, detectedY, 18, 0, 2 * Math.PI);
            testCtx.fill();
            testCtx.stroke();
            
            // Thick dark green checkmark
            testCtx.strokeStyle = '#006600';
            testCtx.lineWidth = 5;
            testCtx.lineCap = 'round';
            testCtx.beginPath();
            testCtx.moveTo(detectedX - 10, detectedY);
            testCtx.lineTo(detectedX - 3, detectedY + 7);
            testCtx.lineTo(detectedX + 10, detectedY - 7);
            testCtx.stroke();
        }
    });
}

function clearDefectMarkers() {
    const referenceCanvas = document.getElementById('reference-overlay');
    const testCanvas = document.getElementById('test-overlay');
    
    if (referenceCanvas) {
        const refCtx = referenceCanvas.getContext('2d');
        refCtx.clearRect(0, 0, referenceCanvas.width, referenceCanvas.height);
    }
    
    if (testCanvas) {
        const testCtx = testCanvas.getContext('2d');
        testCtx.clearRect(0, 0, testCanvas.width, testCanvas.height);
    }
}

function resetImageView() {
    markersVisible = false;
    const button = document.getElementById('marker-toggle');
    button.innerHTML = '<i class="fas fa-eye me-1"></i>Show Defect Markers';
    button.classList.remove('btn-primary');
    button.classList.add('btn-outline-primary');
    clearDefectMarkers();
}

// Auto-resize canvases when window resizes
window.addEventListener('resize', function() {
    if (markersVisible) {
        setTimeout(drawDefectMarkers, 100);
    }
});

// Draw markers when images load
document.addEventListener('DOMContentLoaded', function() {
    const referenceImg = document.getElementById('reference-image');
    const testImg = document.getElementById('test-image');
    
    if (referenceImg && testImg) {
        let imagesLoaded = 0;
        const checkImagesLoaded = () => {
            imagesLoaded++;
            if (imagesLoaded === 2) {
                // Both images loaded, set up canvases
                setTimeout(() => {
                    const referenceCanvas = document.getElementById('reference-overlay');
                    const testCanvas = document.getElementById('test-overlay');
                    if (referenceCanvas && testCanvas) {
                        referenceCanvas.width = referenceImg.clientWidth;
                        referenceCanvas.height = referenceImg.clientHeight;
                        testCanvas.width = testImg.clientWidth;
                        testCanvas.height = testImg.clientHeight;
                    }
                }, 100);
            }
        };
        
        if (referenceImg.complete) checkImagesLoaded();
        else referenceImg.onload = checkImagesLoaded;
        
        if (testImg.complete) checkImagesLoaded();
        else testImg.onload = checkImagesLoaded;
    }
});
</script>

<style>
.image-comparison-container {
    position: relative;
}

.image-comparison-container img {
    max-width: 100%;
    height: auto;
    display: block;
}

#reference-overlay, #test-overlay {
    pointer-events: none;
    border-radius: 0.375rem;
}

.btn-group .btn {
    margin-right: 0;
}

@media (max-width: 768px) {
    .image-comparison-container {
        margin-bottom: 2rem;
    }
}
</style>
{% endblock %}
